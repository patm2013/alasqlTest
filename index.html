<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>AlaSQL Test</title>
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

	<script src="js/jquery.min.js"></script>
	<script src='js/xlsx.core.min.js'></script>
	<script src="js/alasql.min.js"></script>
	<script src="js/underscore.min.js"></script>

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
	<div class="container" style="padding-top: 50px">
        <div class="row">
            <div class="columns twelve">
                <h5>1. Select an Excel File:</h5>
                <input id="readfile" type="file" onchange="loadFile(event)"/>
            </div>
        </div>
        <hr>
        <div class="row" id="qry">
            <div class="columns twelve">
                <h5>2. Write a SQL Query</h5>
                <form action="" id="frmSQL">
                    <input class="u-full-width" type="text" id="sql">
                    <button class="button-primary" type="submit">Go</button>
                </form>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="columns twelve">
            <h5 id="tableName"></h5>
                <table class="u-full-width" id="dataTable">
                    <thead id="tableHeader">

                    </thead>
                    <tbody id="tableBody">
                        
                    </tbody>
                </table>
            </div>
        </div>
    </div>
	

    
	<script>

		$("#frmSQL").on('submit', function(e){
			e.preventDefault();
            queryTable($("#sql").val());
		});
		function loadFile(event) {
            //set table name
            var tableName = "users";
            $("#tableName").text(tableName);
			//alasql("CREATE TABLE names (firstName string, lastName string)");
            $("html, body").animate({scrollTop: $("#qry").offset().top-35}, 2000);

            alasql('SELECT * FROM FILE(?,{headers:true})',[event],function(data){
                // Process data here
                createTable(data, tableName);
            });
         }

         //Create ala table
         function createTable(arrData, strName) {
            var strCTbl = "CREATE TABLE " + strName;
            alasql(strCTbl);
            var strPTbl = "SELECT * INTO " + strName + " FROM ?";
            alasql(strPTbl, [arrData]);
         	htmlTable(arrData);
         }

         // function iterData(arrRows){
         //    var arrTmp = [];
         //    _.each(arrRows, function(d){
         //        var tmpStr = '';
         //        for (var prop in d) {
         //            tmpStr += 
         //        }
         //    });
         // }

         function insertNames(fName, lName) {
         	alasql('INSERT INTO names VALUES("' + fName + '","' + lName + '")');
         }

         //Create HTML Table
         function htmlTable(data) {
         	//Clear Table
         	$("#tableHeader").html('');
            $("#tableBody").html('');

            //Create Headers
         	var arrHeaders = _.keys(data[0]);
         	var tmpHeaders = "<tr>";
         	_.each(arrHeaders, function(header){
         		tmpHeaders += "<th>" + header + "</th>";
         	});
         	tmpHeaders += "</tr>";
         	$("#tableHeader").append(tmpHeaders);

         	//Create Body
         	var tmpArr = [];
         	_.each(data, function(d){
         		var tmpString = '';
         		tmpString = "<tr>"
         		for (var prop in d) {
         			tmpString += "<td>" + d[prop] + "</td>";
         		}
         		tmpString += "</tr>"
         		tmpArr.push(tmpString);
         	});
         	_.each(tmpArr, function(row){
         		$("#tableBody").append(row);
         	});
         }

         function queryTable(qryString) {
            htmlTable(alasql(qryString));
         }
	</script>
</body>
</html>